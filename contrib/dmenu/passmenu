#!/usr/bin/env bash

shopt -s nullglob globstar

action=copy
case $1 in
	--type)
		action=type
		shift
		;;
	--type-and-copy)
		action=typeandcopy
		shift
		;;
esac

prefix=${PASSWORD_STORE_DIR-~/.password-store}
password_files=( "$prefix"/**/*.gpg )
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )
X_SELECTION="${PASSWORD_STORE_X_SELECTION:-clipboard}"
copy_cmd=( xclip -selection "$X_SELECTION" )

password=$(printf '%s\n' "${password_files[@]}" | dmenu "$@")

[[ -n $password ]] || exit

case $action in
	copy)
		pass show --clip "$password" 2>/dev/null
		;;
	type)
		pass show "$password" | head --lines 1 | tr --delete '\n' \
			| xdotool type --clearmodifiers --file -
		;;
	typeandcopy)
		pass show "$password" \
			| tee >(head --lines 1 | tr --delete '\n' | "${copy_cmd[@]}") \
			| head --lines 2 | tail --lines +2 | tr --delete '\n' \
			| xdotool type --clearmodifiers --file -
		;;
esac
